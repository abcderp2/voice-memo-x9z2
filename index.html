<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline'; style-src 'self' 'unsafe-inline'; img-src 'self' data:; object-src 'none'; base-uri 'none'; form-action 'self'; frame-ancestors 'none';">
<meta name="referrer" content="no-referrer">
<meta http-equiv="X-Content-Type-Options" content="nosniff">

<title>Secure Voice Memo</title>

<style>
  /* 2. 外部フォントを使用せず、システムフォントのみを使用（プライバシー保護と高速化） */
  :root {
    --bg-color: #f4f6f8;
    --text-color: #333;
    --accent-color: #2c3e50;
    --btn-primary: #0056b3;
    --btn-danger: #bd2130;
  }
  
  body {
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
    background-color: var(--bg-color);
    color: var(--text-color);
    padding: 20px;
    max-width: 800px;
    margin: 0 auto;
    line-height: 1.6;
  }

  h1 { font-size: 1.5rem; margin-bottom: 1rem; color: var(--accent-color); border-bottom: 2px solid #ddd; padding-bottom: 0.5rem; }

  /* セキュリティリスクとなるiframe等は使用しない */
  
  #status-indicator {
    font-weight: bold;
    font-size: 0.9rem;
    margin-bottom: 10px;
    padding: 8px 12px;
    border-radius: 4px;
    background-color: #e9ecef;
    display: inline-block;
  }

  textarea {
    width: 100%;
    height: 40vh; /* 画面の高さの40% */
    padding: 15px;
    border: 1px solid #ccc;
    border-radius: 8px;
    font-size: 16px; /* スマホでズームされないサイズ */
    resize: vertical;
    box-shadow: inset 0 1px 3px rgba(0,0,0,0.1);
    margin-bottom: 20px;
    box-sizing: border-box;
  }

  .controls {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 10px;
  }

  button {
    padding: 15px;
    font-size: 1rem;
    border: none;
    border-radius: 6px;
    cursor: pointer;
    font-weight: bold;
    transition: opacity 0.2s;
    touch-action: manipulation; /* ダブルタップ防止 */
  }

  button:active { opacity: 0.8; }
  
  #btn-start { background-color: var(--btn-primary); color: white; }
  #btn-stop { background-color: var(--btn-danger); color: white; }
  #btn-copy { background-color: #6c757d; color: white; }
  
  /* マイク使用中の視覚的フィードバック */
  .recording {
    background-color: #ffebee !important;
    color: #c62828 !important;
    border: 1px solid #ffcdd2;
    animation: pulse 2s infinite;
  }

  @keyframes pulse {
    0% { box-shadow: 0 0 0 0 rgba(255, 0, 0, 0.4); }
    70% { box-shadow: 0 0 0 10px rgba(255, 0, 0, 0); }
    100% { box-shadow: 0 0 0 0 rgba(255, 0, 0, 0); }
  }
</style>
</head>
<body>

<h1>音声メモ（Secure Mode）</h1>

<div id="status-indicator">待機中 - 安全な接続</div>
<textarea id="transcript-area" placeholder="マイク権限を許可して開始を押してください..."></textarea>

<div class="controls">
  <button id="btn-start" type="button">開始</button>
  <button id="btn-stop" type="button">停止</button>
  <button id="btn-copy" type="button">コピー</button>
</div>

<script>
(function() {
  'use strict'; // 厳格モードの適用

  // DOM要素の取得
  const startBtn = document.getElementById('btn-start');
  const stopBtn = document.getElementById('btn-stop');
  const copyBtn = document.getElementById('btn-copy');
  const textArea = document.getElementById('transcript-area');
  const statusDiv = document.getElementById('status-indicator');

  let recognition = null;

  // Web Speech APIの初期化
  if ('SpeechRecognition' in window || 'webkitSpeechRecognition' in window) {
    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
    recognition = new SpeechRecognition();
    recognition.lang = 'ja-JP';
    recognition.interimResults = true;
    recognition.continuous = true;

    // イベントリスナの設定
    recognition.onstart = function() {
      updateStatus('● 録音中', true);
    };

    recognition.onend = function() {
      updateStatus('待機中', false);
    };

    recognition.onresult = function(event) {
      let finalTranscript = '';
      let interimTranscript = '';

      for (let i = event.resultIndex; i < event.results.length; i++) {
        const transcript = event.results[i][0].transcript;
        if (event.results[i].isFinal) {
          finalTranscript += transcript + '\n';
        } else {
          interimTranscript += transcript;
        }
      }

      // XSS対策: innerHTMLを使わず、valueプロパティへの代入のみを行う
      // これにより、もし音声入力で「<script>...」と認識されてもコードは実行されない
      if (finalTranscript) {
        // 現在のカーソル位置に挿入するのではなく、末尾に追加（最も安全な実装）
        textArea.value += finalTranscript;
        // 自動スクロール
        textArea.scrollTop = textArea.scrollHeight;
      }
    };

    recognition.onerror = function(event) {
      console.error('Speech recognition error', event.error);
      updateStatus('エラー: ' + event.error, false);
    };
  } else {
    updateStatus('このブラウザは非対応です', false);
    startBtn.disabled = true;
  }

  // ボタン操作のバインディング
  startBtn.addEventListener('click', function() {
    if (recognition) {
      try { recognition.start(); } catch(e) { console.log('Already started'); }
    }
  });

  stopBtn.addEventListener('click', function() {
    if (recognition) recognition.stop();
  });

  copyBtn.addEventListener('click', function() {
    // Clipboard APIの使用（execCommandよりセキュアで推奨される方法）
    if (navigator.clipboard) {
      navigator.clipboard.writeText(textArea.value).then(function() {
        const originalText = copyBtn.textContent;
        copyBtn.textContent = '完了!';
        setTimeout(() => copyBtn.textContent = originalText, 1000);
      }).catch(function(err) {
        console.error('Copy failed', err);
        alert('コピーに失敗しました');
      });
    } else {
      textArea.select();
      document.execCommand('copy');
    }
  });

  // 状態表示の更新関数（XSS対策のためtextContentを使用）
  function updateStatus(text, isRecording) {
    statusDiv.textContent = text;
    if (isRecording) {
      statusDiv.classList.add('recording');
    } else {
      statusDiv.classList.remove('recording');
    }
  }

})();
</script>
</body>
</html>
