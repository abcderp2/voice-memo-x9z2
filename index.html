<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

<meta http-equiv="Content-Security-Policy" content="default-src 'self'; media-src 'self' https://translate.google.com; script-src 'self' 'unsafe-inline'; style-src 'self' 'unsafe-inline'; object-src 'none'; base-uri 'none';">
<meta name="referrer" content="no-referrer">

<title>Cloud Voice Pro v7</title>

<style>
  :root { --bg: #121212; --card: #1e1e1e; --text: #e0e0e0; --accent: #0a84ff; --danger: #ff453a; }
  
  body {
    background-color: var(--bg); color: var(--text);
    font-family: -apple-system, BlinkMacSystemFont, Roboto, sans-serif;
    margin: 0; padding: 20px;
    display: flex; flex-direction: column; height: 100vh; box-sizing: border-box;
  }

  h1 { font-size: 1rem; color: #888; text-align: center; margin: 0 0 15px 0; border-bottom: 1px solid #333; padding-bottom: 10px; }

  .panel {
    background: var(--card); padding: 15px; border-radius: 12px;
    margin-bottom: 15px; border: 1px solid #333;
  }

  .slider-group { display: flex; justify-content: space-between; align-items: center; font-size: 14px; }
  input[type=range] { flex-grow: 1; margin-left: 15px; cursor: pointer; }

  textarea {
    flex-grow: 1; width: 100%;
    background: #1c1c1e; color: #fff;
    border: 1px solid #333; border-radius: 10px;
    padding: 15px; font-size: 17px; line-height: 1.6;
    resize: none; box-sizing: border-box; margin-bottom: 15px;
    font-family: inherit;
  }
  textarea:focus { outline: 2px solid var(--accent); border-color: transparent; }

  .btn-group { display: grid; grid-template-columns: 2fr 1fr; gap: 15px; }
  
  button {
    padding: 16px; border: none; border-radius: 12px;
    font-size: 16px; font-weight: bold; cursor: pointer;
    color: white; transition: opacity 0.2s;
  }
  button:active { opacity: 0.7; }
  button:disabled { opacity: 0.3; cursor: not-allowed; }

  #btn-play { background: var(--accent); }
  #btn-stop { background: var(--danger); }

  #status { text-align: center; font-size: 13px; color: #888; margin-top: 10px; min-height: 20px; }
  .active { color: #30d158 !important; }

</style>
</head>
<body>

<h1>CLOUD VOICE PRO v7</h1>

<div class="panel">
  <div class="slider-group">
    <span>速度 (Speed): <span id="rate-val">1.0</span></span>
    <input type="range" id="rate" min="0.5" max="2.0" step="0.25" value="1.0">
  </div>
</div>

<textarea id="text-input" placeholder="ここに文章を入力してください。">こんにちは。速度設定が途中で戻らないように修正されました。</textarea>

<div class="btn-group">
  <button id="btn-play">再生 (PLAY)</button>
  <button id="btn-stop">停止 (STOP)</button>
</div>

<div id="status">Ready</div>

<script>
(function() {
  'use strict';

  const inputEl = document.getElementById('text-input');
  const btnPlay = document.getElementById('btn-play');
  const btnStop = document.getElementById('btn-stop');
  const statusEl = document.getElementById('status');
  const rateInput = document.getElementById('rate');
  const rateVal = document.getElementById('rate-val');

  let audioPlayer = new Audio();
  let chunkQueue = [];
  let isPlaying = false;
  let currentChunkIndex = 0;

  // --- 設定の復元（LocalStorage） ---
  
  // テキストの復元
  if(localStorage.getItem('cloud-tts-text')) {
    inputEl.value = localStorage.getItem('cloud-tts-text');
  }
  
  // 速度設定の復元（これ重要）
  if(localStorage.getItem('cloud-tts-rate')) {
    const savedRate = localStorage.getItem('cloud-tts-rate');
    rateInput.value = savedRate;
    rateVal.textContent = parseFloat(savedRate).toFixed(2); // 表示も更新
  }

  // 自動保存処理
  inputEl.addEventListener('input', () => localStorage.setItem('cloud-tts-text', inputEl.value));
  
  rateInput.addEventListener('input', (e) => {
    const val = e.target.value;
    rateVal.textContent = parseFloat(val).toFixed(2);
    localStorage.setItem('cloud-tts-rate', val); // 設定変更時に即保存
    
    // 再生中ならリアルタイムで反映
    if(isPlaying && audioPlayer) {
      audioPlayer.playbackRate = parseFloat(val);
    }
  });

  // --- 長文分割処理 ---
  function splitText(text) {
    const rawChunks = text.split(/([。、\n\.\?!]+)/);
    let chunks = [];
    let buffer = "";
    for (let part of rawChunks) {
      if (buffer.length + part.length < 100) {
        buffer += part;
      } else {
        if (buffer) chunks.push(buffer);
        buffer = part;
      }
    }
    if (buffer) chunks.push(buffer);
    return chunks.filter(c => c.trim().length > 0);
  }

  // --- 再生コアロジック ---
  function playNextChunk() {
    if (currentChunkIndex >= chunkQueue.length || !isPlaying) {
      finishPlayback();
      return;
    }

    const text = chunkQueue[currentChunkIndex];
    statusEl.textContent = `再生中 (${currentChunkIndex + 1}/${chunkQueue.length})...`;
    statusEl.classList.add('active');

    const url = `https://translate.google.com/translate_tts?ie=UTF-8&q=${encodeURIComponent(text)}&tl=ja&client=tw-ob`;
    
    audioPlayer.src = url;
    
    // 【修正ポイント】
    // srcを変更すると速度が1.0にリセットされるため、
    // "メタデータ読み込み完了"のタイミングで、再度速度を強制設定する
    audioPlayer.onloadedmetadata = function() {
        const currentRate = parseFloat(rateInput.value);
        audioPlayer.playbackRate = currentRate;
        audioPlayer.play().catch(e => {
            console.error(e);
            statusEl.textContent = "ブロックされました。もう一度押してください";
            isPlaying = false;
        });
    };
  }

  // 次の音声へ
  audioPlayer.onended = function() {
    currentChunkIndex++;
    playNextChunk();
  };

  audioPlayer.onerror = function() {
    console.warn("Error skipping chunk");
    currentChunkIndex++;
    playNextChunk();
  };

  // --- ボタン操作 ---
  function startPlayback() {
    const text = inputEl.value;
    if (!text) return;

    isPlaying = true;
    chunkQueue = splitText(text);
    currentChunkIndex = 0;
    
    if (chunkQueue.length === 0) return;

    btnPlay.disabled = true;
    btnStop.disabled = false;
    
    playNextChunk();
  }

  function finishPlayback() {
    isPlaying = false;
    statusEl.textContent = "完了";
    statusEl.classList.remove('active');
    btnPlay.disabled = false;
    btnStop.disabled = true;
  }

  function stopPlayback() {
    isPlaying = false;
    audioPlayer.pause();
    statusEl.textContent = "停止しました";
    statusEl.classList.remove('active');
    btnPlay.disabled = false;
    btnStop.disabled = true;
  }

  btnPlay.addEventListener('click', startPlayback);
  btnStop.addEventListener('click', stopPlayback);
  btnStop.disabled = true;

})();
</script>
</body>
</html>
