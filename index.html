<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

<meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline'; style-src 'self' 'unsafe-inline'; img-src 'self' data:; object-src 'none'; base-uri 'none';">
<meta name="referrer" content="no-referrer">

<title>Secure Voice Pro</title>

<style>
  :root { --bg: #121212; --card: #1e1e1e; --text: #e0e0e0; --accent: #bb86fc; --err: #cf6679; }
  body {
    background-color: var(--bg); color: var(--text);
    font-family: -apple-system, BlinkMacSystemFont, Roboto, sans-serif;
    margin: 0; padding: 16px; display: flex; flex-direction: column; height: 100vh; box-sizing: border-box;
  }
  h1 { font-size: 1.1rem; margin: 0 0 16px 0; color: var(--accent); border-bottom: 1px solid #333; padding-bottom: 8px; }
  
  .controls { background: var(--card); padding: 16px; border-radius: 12px; margin-bottom: 16px; box-shadow: 0 4px 6px rgba(0,0,0,0.3); }
  
  select, input[type=range] { width: 100%; background: #333; color: #fff; border: 1px solid #444; padding: 8px; border-radius: 4px; margin-bottom: 12px; }
  label { font-size: 0.8rem; color: #aaa; display: block; margin-bottom: 4px; }
  
  textarea {
    flex-grow: 1; width: 100%; background: #2c2c2c; color: #fff; border: 1px solid #444; border-radius: 8px;
    padding: 12px; font-size: 16px; resize: none; margin-bottom: 16px; box-sizing: border-box;
  }
  
  .btn-group { display: grid; grid-template-columns: 2fr 1fr; gap: 12px; height: 56px; }
  button {
    border: none; border-radius: 8px; font-weight: bold; font-size: 1rem; color: #000; cursor: pointer;
  }
  #btn-play { background-color: var(--accent); }
  #btn-stop { background-color: var(--err); color: #fff; }
  button:active { opacity: 0.8; transform: scale(0.98); }

  /* 診断ログ表示エリア */
  #debug-log {
    font-family: monospace; font-size: 0.7rem; color: #666; 
    border-top: 1px solid #333; padding-top: 8px; margin-top: auto;
    height: 60px; overflow-y: scroll; white-space: pre-wrap;
  }
</style>
</head>
<body>

<h1>Secure Voice Pro (v4.0)</h1>

<div class="controls">
  <label>音声の種類 (Voice)</label>
  <select id="voice-select"><option>システム標準</option></select>
  
  <div style="display:flex; gap:10px;">
    <div style="flex:1;">
      <label>速さ: <span id="rate-val">1.0</span></label>
      <input type="range" id="rate" min="0.5" max="2" step="0.1" value="1.0">
    </div>
    <div style="flex:1;">
      <label>高さ: <span id="pitch-val">1.0</span></label>
      <input type="range" id="pitch" min="0.5" max="1.5" step="0.1" value="1.0">
    </div>
  </div>
</div>

<textarea id="text-input" placeholder="ここに文字を入力...">テスト音声です。聞こえますか？</textarea>

<div class="btn-group">
  <button id="btn-play">再生 (PLAY)</button>
  <button id="btn-stop">停止 (STOP)</button>
</div>

<div id="debug-log">System Ready...</div>

<script>
(function() {
  'use strict';
  
  // 要素取得
  const synth = window.speechSynthesis;
  const btnPlay = document.getElementById('btn-play');
  const btnStop = document.getElementById('btn-stop');
  const txtInput = document.getElementById('text-input');
  const voiceSelect = document.getElementById('voice-select');
  const logArea = document.getElementById('debug-log');
  
  let voices = [];
  let keepAliveTimer = null; // スマホでの途中停止を防ぐタイマー

  // ログ出力関数
  function log(msg) {
    const t = new Date().toLocaleTimeString();
    logArea.textContent = `[${t}] ${msg}\n` + logArea.textContent;
    console.log(msg);
  }

  // 初期化：以前のデータを復元
  if(localStorage.getItem('saved-text')) txtInput.value = localStorage.getItem('saved-text');
  txtInput.addEventListener('input', () => localStorage.setItem('saved-text', txtInput.value));

  // スライダーUI更新
  document.getElementById('rate').oninput = (e) => document.getElementById('rate-val').textContent = e.target.value;
  document.getElementById('pitch').oninput = (e) => document.getElementById('pitch-val').textContent = e.target.value;

  // 音声リスト読み込み（スマホ対応の強力版）
  function loadVoices() {
    voices = synth.getVoices();
    log(`Voices loaded: ${voices.length}`);
    
    if (voices.length > 0) {
      voiceSelect.innerHTML = '';
      // 日本語を優先
      voices.sort((a,b) => (b.lang.includes('ja') ? 1 : 0) - (a.lang.includes('ja') ? 1 : 0));
      
      voices.forEach(v => {
        const opt = document.createElement('option');
        opt.textContent = v.name + (v.default ? ' (標準)' : '');
        opt.value = v.name;
        voiceSelect.appendChild(opt);
      });
    } else {
      log("Voice list is empty. Retrying...");
    }
  }

  // iOS/Androidでの読み込みタイミング対策
  loadVoices();
  if (synth.onvoiceschanged !== undefined) {
    synth.onvoiceschanged = loadVoices;
  }
  // 強制リトライ（一部のAndroid/iOSでイベントが発火しないため）
  setTimeout(loadVoices, 1000);

  // 再生処理（最も安定するシンプルかつ強力な実装）
  btnPlay.addEventListener('click', () => {
    // 1. まず現在の再生をキャンセル（iOS必須）
    synth.cancel();
    if (keepAliveTimer) clearInterval(keepAliveTimer);
    
    const text = txtInput.value;
    if (!text) { log("Text is empty"); return; }

    log("Play button clicked");

    // 2. 発話オブジェクト作成
    const u = new SpeechSynthesisUtterance(text);
    
    // 3. 音声設定
    const selectedName = voiceSelect.value;
    const voice = voices.find(v => v.name === selectedName);
    if (voice) {
      u.voice = voice;
      log(`Selected voice: ${voice.name}`);
    } else {
      u.lang = 'ja-JP'; // 見つからない場合は言語指定のみ
      log("Using default JP voice");
    }

    u.rate = parseFloat(document.getElementById('rate').value);
    u.pitch = parseFloat(document.getElementById('pitch').value);
    u.volume = 1.0; // 音量最大

    // 4. イベントハンドラ
    u.onstart = () => {
      log("Speech started");
      btnPlay.disabled = true;
      btnPlay.style.opacity = 0.5;
    };
    
    u.onend = () => {
      log("Speech ended");
      btnPlay.disabled = false;
      btnPlay.style.opacity = 1;
      if (keepAliveTimer) clearInterval(keepAliveTimer);
    };

    u.onerror = (e) => {
      log(`Error: ${e.error}`);
      btnPlay.disabled = false;
      btnPlay.style.opacity = 1;
      if (keepAliveTimer) clearInterval(keepAliveTimer);
    };

    // 5. スマホバグ対策（無限に一時停止・再開を繰り返してガベージコレクションを防ぐ）
    keepAliveTimer = setInterval(() => {
      if (!synth.speaking) {
        clearInterval(keepAliveTimer);
        return;
      }
      synth.pause();
      synth.resume();
    }, 14000); // 14秒ごとにリフレッシュ

    // 6. 再生実行
    try {
      synth.speak(u);
      log("Speak command sent");
    } catch (e) {
      log(`Exception: ${e.message}`);
    }
  });

  // 停止処理
  btnStop.addEventListener('click', () => {
    synth.cancel();
    if (keepAliveTimer) clearInterval(keepAliveTimer);
    log("Stopped manually");
    btnPlay.disabled = false;
    btnPlay.style.opacity = 1;
  });

})();
</script>
</body>
</html>
